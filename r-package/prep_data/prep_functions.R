#### Support functions to use in the preprocessing of the data

library(dplyr)
library(data.table)
library(magrittr)

###### list ftp folders -----------------

# function to list ftp folders from their original sub-dir
list_folders <- function(ftp){

  if (substr(ftp, nchar(ftp), nchar(ftp)) != "/") {
    ftp<-paste0(ftp,"/")
  }
  ##List Years/folders available
  years = getURL(ftp, ftp.use.epsv = FALSE, dirlistonly = TRUE)
  years <- strsplit(years, "\r\n")
  years = unlist(years)

  return(years)

}

###### Download data -----------------



###### Unzip data -----------------

# function to Unzip files in their original sub-dir
# unzip_fun <- function(f, head_dir){
#   unzip(f, exdir = file.path(head_dir, substr(f, 3, 6)))
# }
unzip_fun <- function(f){
  # f <- files_1st_batch[1]
  t<-strsplit(f, "/")
  t<-t[[1]][length(t[[1]])]
  t<- nchar(t)
  unzip(f, exdir = file.path(head_dir, substr(f, 3, nchar(f)-t) ))
}



###### Harmonize spatial projection -----------------

# Harmonize spatial projection CRS, using SIRGAS 2000 epsg (SRID): 4674

harmonize_projection <- function(temp_sf){

  temp_sf <- if( is.na(st_crs(temp_sf)) ){ st_set_crs(temp_sf, 4674) } else { st_transform(temp_sf, 4674) }
  st_crs(temp_sf) <- 4674

  return(temp_sf)
  }


###### Add State abbreviation -----------------

add_state_info <- function(temp_sf, column){

  if(!is.null(temp_sf$code_muni)){
  # Add code_state
  temp_sf <- dplyr::mutate(code_state = ifelse(name_state== "Rondonia" | name_state== "Território De Rondonia"  | name_state== "Territorio de Rondonia",11,
                                        ifelse(name_state== "Acre" | name_state== "Território do Acre",12,
                                        ifelse(name_state== "Amazonas",13,
                                        ifelse(name_state== "Roraima" | name_state=="Território de Roraima",14,
                                        ifelse(name_state== "Pará",15,
                                        ifelse(name_state== "Amapá" | name_state=="Territorio do Amapa",16,
                                        ifelse(name_state== "Tocantins",17,
                                        ifelse(name_state== "Maranhão",21,
                                        ifelse(name_state== "Piaui" | name_state== "Piauhy",22,
                                        ifelse(name_state== "Ceará",23,
                                        ifelse(name_state== "Rio Grande do Norte",24,
                                        ifelse(name_state== "Paraiba" | name_state== "Parahyba",25,
                                        ifelse(name_state== "Pernambuco",26,
                                        ifelse(name_state== "Alagoas" | name_state=="Alagôas",27,
                                        ifelse(name_state== "Sergipe",28,
                                        ifelse(name_state== "Bahia",29,
                                        ifelse(name_state== "Minas Gerais" | name_state== "Minas Geraes",31,
                                        ifelse(name_state== "Espirito Santo" | name_state== "Espirito Santo",32,
                                        ifelse(name_state== "Rio de Janeiro",33,
                                        ifelse(name_state== "São Paulo",35,
                                        ifelse(name_state== "Paraná",41,
                                        ifelse(name_state== "Santa Catarina" | name_state== "Santa Catharina",42,
                                        ifelse(name_state== "Rio Grande do Sul",43,
                                        ifelse(name_state== "Mato Grosso do Sul",50,
                                        ifelse(name_state== "Mato Grosso" | name_state== "Matto Grosso",51,
                                        ifelse(name_state== "Goiás" | name_state== "Goyaz",52,
                                        ifelse((name_state== "Distrito Federal" | name_state=="Brasilia") & (year>1950),53,NA
                                        ))))))))))))))))))))))))))))
  }
  if( column != 'name_state'){

  # add code_state
  temp_sf$code_state <- substr( temp_sf[[ column ]] , 1,2) %>% as.numeric()

  # add name_state
  temp_sf <- temp_sf %>% mutate(name_state =  ifelse(code_state== 11, utf8::as_utf8("Rondônia"),
                                              ifelse(code_state== 12, utf8::as_utf8("Acre"),
                                              ifelse(code_state== 13, utf8::as_utf8("Amazônas"),
                                              ifelse(code_state== 14, utf8::as_utf8("Roraima"),
                                              ifelse(code_state== 15, utf8::as_utf8("Pará"),
                                              ifelse(code_state== 16, utf8::as_utf8("Amapá"),
                                              ifelse(code_state== 17, utf8::as_utf8("Tocantins"),
                                              ifelse(code_state== 21, utf8::as_utf8("Maranhão"),
                                              ifelse(code_state== 22, utf8::as_utf8("Piauí"),
                                              ifelse(code_state== 23, utf8::as_utf8("Ceará"),
                                              ifelse(code_state== 24, utf8::as_utf8("Rio Grande do Norte"),
                                              ifelse(code_state== 25, utf8::as_utf8("Paraíba"),
                                              ifelse(code_state== 26, utf8::as_utf8("Pernambuco"),
                                              ifelse(code_state== 27, utf8::as_utf8("Alagoas"),
                                              ifelse(code_state== 28, utf8::as_utf8("Sergipe"),
                                              ifelse(code_state== 29, utf8::as_utf8("Bahia"),
                                              ifelse(code_state== 31, utf8::as_utf8("Minas Gerais"),
                                              ifelse(code_state== 32, utf8::as_utf8("Espírito Santo"),
                                              ifelse(code_state== 33, utf8::as_utf8("Rio de Janeiro"),
                                              ifelse(code_state== 35, utf8::as_utf8("São Paulo"),
                                              ifelse(code_state== 41, utf8::as_utf8("Paraná"),
                                              ifelse(code_state== 42, utf8::as_utf8("Santa Catarina"),
                                              ifelse(code_state== 43, utf8::as_utf8("Rio Grande do Sul"),
                                              ifelse(code_state== 50, utf8::as_utf8("Mato Grosso do Sul"),
                                              ifelse(code_state== 51, utf8::as_utf8("Mato Grosso"),
                                              ifelse(code_state== 52, utf8::as_utf8("Goiás"),
                                              ifelse(code_state== 53, utf8::as_utf8("Distrito Federal"), "!error!"))))))))))))))))))))))))))))
  }

  # add abbrev state
  temp_sf <- temp_sf %>% mutate(abbrev_state = ifelse(code_state== 11, "RO",
                                               ifelse(code_state== 12, "AC",
                                               ifelse(code_state== 13, "AM",
                                               ifelse(code_state== 14, "RR",
                                               ifelse(code_state== 15, "PA",
                                               ifelse(code_state== 16, "AP",
                                               ifelse(code_state== 17, "TO",
                                               ifelse(code_state== 21, "MA",
                                               ifelse(code_state== 22, "PI",
                                               ifelse(code_state== 23, "CE",
                                               ifelse(code_state== 24, "RN",
                                               ifelse(code_state== 25, "PB",
                                               ifelse(code_state== 26, "PE",
                                               ifelse(code_state== 27, "AL",
                                               ifelse(code_state== 28, "SE",
                                               ifelse(code_state== 29, "BA",
                                               ifelse(code_state== 31, "MG",
                                               ifelse(code_state== 32, "ES",
                                               ifelse(code_state== 33, "RJ",
                                               ifelse(code_state== 35, "SP",
                                               ifelse(code_state== 41, "PR",
                                               ifelse(code_state== 42, "SC",
                                               ifelse(code_state== 43, "RS",
                                               ifelse(code_state== 50, "MS",
                                               ifelse(code_state== 51, "MT",
                                               ifelse(code_state== 52, "GO",
                                               ifelse(code_state== 53, "DF",NA))))))))))))))))))))))))))))

return(temp_sf)
}



###### Add Region info -----------------

add_region_info <- function(temp_sf, column){

  # add code_region
  temp_sf$code_region <- substr( temp_sf[[ column ]] , 1,1) %>% as.numeric()

  # add name_region
  temp_sf <- temp_sf %>% mutate(name_region = ifelse(code_region==1, 'Norte',
                                              ifelse(code_region==2, 'Nordeste',
                                              ifelse(code_region==3, 'Sudeste',
                                              ifelse(code_region==4, 'Sul',
                                              ifelse(code_region==5, 'Centro Oeste', NA))))))
  return(temp_sf)
                                              }



###### Use UTF-8 encoding -----------------

use_encoding_utf8 <- function(temp_sf){


  temp_sf <- temp_sf %>%
  mutate_if(is.factor, function(x){
    x %>% as.character() %>% stringi::stri_encode(to="UTF-8") } )

  temp_sf <- temp_sf %>%
    mutate_if(is.character, function(x){
      x  %>% stringi::stri_encode(to="UTF-8") } )

  return(temp_sf)
  }


###### convert to MULTIPOLYGON -----------------

to_multipolygon <- function(temp_sf){
if( st_geometry_type(temp_sf) %>% unique() %>% as.character() %>% length() > 1 |
    any(  !( st_geometry_type(temp_sf) %>% unique() %>% as.character() %like% "MULTIPOLYGON|GEOMETRYCOLLECTION"))) {
  # remove linstring
  temp_sf <- subset(temp_sf, st_geometry_type(temp_sf) %>% as.character() != "LINESTRING")
  temp_sf <- sf::st_cast(temp_sf, "MULTIPOLYGON")
  return(temp_sf)
}else{ return(temp_sf)}}


###### Simplify temp_sf -----------------

simplify_temp_sf <- function(temp_sf, tolerance=100){

  # reproject to utm
  temp_gpkg_simplified <- sf::st_transform(temp_sf, crs=3857)

  # simplify with tolerance
  temp_gpkg_simplified <- sf::st_simplify(temp_gpkg_simplified, preserveTopology = T, dTolerance = tolerance)

  # reproject to utm
  temp_gpkg_simplified <- sf::st_transform(temp_gpkg_simplified, crs=4674)

  # Make any invalid geometry valid # st_is_valid( sf)
  temp_gpkg_simplified <- sf::st_make_valid(temp_gpkg_simplified)

  return(temp_gpkg_simplified)
}



###### Dissolve borders temp_sf -----------------

## Function to clean and dissolve the borders of polygons by groups
dissolve_polygons <- function(mysf, group_column){


  # a) make sure we have valid geometries
  temp_sf <- sf::st_make_valid(mysf)
  temp_sf <- temp_sf %>% st_buffer(0)

  # b) make sure we have sf MULTIPOLYGON
  temp_sf1 <- temp_sf %>% st_cast("MULTIPOLYGON")

  # c) long but complete dissolve function
  dissolvefun <- function(grp){

    # c.1) subset region
    temp_region <- subset(mysf, get(group_column, mysf)== grp )


    # c.2) create attribute with the number of points each polygon has
    points_in_each_polygon = sapply(1:dim(temp_region)[1], function(i)
      length(st_coordinates(temp_region$geom[i])))

    temp_region$points_in_each_polygon <- points_in_each_polygon
    mypols <- subset(temp_region, points_in_each_polygon > 0)

    # d) convert to sp
    sf_regiona <- mypols %>% as("Spatial")
    sf_regiona <- rgeos::gBuffer(sf_regiona, byid=TRUE, width=0) # correct eventual topology issues

    # c) dissolve borders to create country file
    result <- maptools::unionSpatialPolygons(sf_regiona, rep(TRUE, nrow(sf_regiona@data))) # dissolve


    # d) get rid of holes
    outerRings = Filter(function(f){f@ringDir==1},result@polygons[[1]]@Polygons)
    outerBounds = sp::SpatialPolygons(list(sp::Polygons(outerRings,ID=1)))

    # e) convert back to sf data
    outerBounds <- st_as_sf(outerBounds)
    outerBounds <- st_set_crs(outerBounds, st_crs(mysf))
    st_crs(outerBounds) <- st_crs(mysf)

    # retrieve code_region info and reorder columns
    outerBounds <- dplyr::mutate(outerBounds, group_column = grp)
    outerBounds <- dplyr::select(outerBounds, group_column, geometry)
    names(outerBounds)[1] <- group_column
    return(outerBounds)
  }


  # Apply sub-function
  groups_sf <- lapply(X = unique(get(group_column, mysf)), FUN = dissolvefun )

  # rbind results
  temp_sf <- do.call('rbind', groups_sf)
  return(temp_sf)
}

                                    
###### Matching function for AMC code -----------------                                    

# funcao criada pelo Phillip para checar repeticao de AMCs

# faz iteracao entre clusters
# comparando clusters entre si repeditamente até estabilizar numero dos clusters

matching <- function(data_mun=NULL, y0){

  temp <- data_mun %>% 
    select(c(paste0("clu",y0),clu_new)) %>% 
    filter(!is.na(clu_new)) %>% 
    arrange(get(paste0("clu",y0)),clu_new) %>% 
    filter(!(get(paste0("clu",y0))==clu_new) ) 
  
  if (nrow(temp) > 1) {
    
    temp$diff <- 0
    
    for(i in 2:nrow(temp)){ if (is.na(temp[,c(paste0("clu",y0))][i-1]) | is.na( temp[,c("clu_new")][i-1]) ) next 
      else if (temp[,c(paste0("clu",y0))][i] == temp[,c(paste0("clu",y0))][i-1] 
               & temp[,c("clu_new")][i] == temp[,c("clu_new")][i-1])
        
        temp$diff[i] <- 1
    }
    
    temp <- temp %>%
      filter(diff != 1)
    
    temp <- temp %>% select(-diff)
    
  } 
  
  # 
  # temp <- fread("exemplo.csv") %>% mutate_all(as.character)
  
  temp <- temp %>% mutate(!!paste0("clu",quo_name(y0)) := ifelse(is.na(get(paste0("clu",y0))),-999999999,get(paste0("clu",y0))))
  
  rep_c<-0
  
  repeat {
    
    
    rep_c <- (rep_c + 1)
    
    while (sum(temp[,c(paste0("clu",y0))] == lag(temp[,c(paste0("clu",y0))],1),na.rm = T) != 0) {
      
      for(i in 2:nrow(temp)) if (temp[,c(paste0("clu",y0))][i] == temp[,c(paste0("clu",y0))][i-1]) temp[,c(paste0("clu",y0))][i] <- temp$clu_new[i] 
      
      for(i in 2:nrow(temp)) if (temp$clu_new[i] == temp[,c(paste0("clu",y0))][i]) temp$clu_new[i] <- temp$clu_new[i-1] 
      
      temp<- temp[order(temp[,1],temp[,2]),]
      
      temp <- temp %>% filter( !(get(paste0("clu",y0)) == clu_new) ) 
      
      # temp <- temp %>% filter( !(get(paste0("clu",y0)) == dplyr::lag(get(paste0("clu",y0)), default = 999999999) & clu_new == dplyr::lag(clu_new, default = 999999999)) ) 
      
      temp$diff <- 0
      
      for(i in 2:nrow(temp)){ if (is.na(temp[,c(paste0("clu",y0))][i-1]) | is.na( temp[,c("clu_new")][i-1]) ) next 
        else if (temp[,c(paste0("clu",y0))][i] == temp[,c(paste0("clu",y0))][i-1] 
                 & temp[,c("clu_new")][i] == temp[,c("clu_new")][i-1])
          
          temp$diff[i] <- 1
      }
      
      temp <- temp %>%
        filter(diff != 1)
      
      temp <- temp %>% select(-diff)
      
      
    }
    
    temp2 <- temp
    
    temp2 <- temp2 %>% rename(help = clu_new, clu_new = paste0("clu",y0) )
    
    temp2 <- bind_rows(temp,temp2) %>% mutate_all(function(x) ifelse(is.na(x),-999999999,x))
    
    temp2<- temp2[order(temp2[,2],-xtfrm(temp2[,3])),]
    
    if (sum(temp2$clu_new == lead(temp2$clu_new,1) & temp2$help != -999999999,na.rm = T) != 0) {
      
      
      temp3 <- temp
      
      temp3 <- temp3 %>% rename(clu_new2 = clu_new, clu_new = paste0("clu",y0) )
      
      temp3 <- left_join(temp,temp3)
      
      temp3 <- temp3 %>% mutate(clu_new2 = ifelse(is.na(clu_new2),clu_new,clu_new2))
      
      temp3 <- temp3 %>% filter( get(paste0("clu",y0))!=-999999999 ) 
      
      temp3 <- temp3 %>% filter( !is.na(get(paste0("clu",y0))) ) 
      
      temp3 <- temp3 %>% select(-clu_new)
      
      temp3 <- temp3 %>% rename(clu_new = clu_new2)
      
      temp3<- temp3[order(temp3[,1],temp3[,2]),]
      
      temp3 <- temp3 %>% filter( !(get(paste0("clu",y0)) == clu_new) ) 
      
      # temp <- temp3 %>% filter( !(get(paste0("clu",y0)) == lag(get(paste0("clu",y0)), default = -999999999) & clu_new == lag(clu_new, default = -999999999)) ) 
      
      temp3$diff <- 0
      
      for(i in 2:nrow(temp3)){ if (is.na(temp3[,c(paste0("clu",y0))][i-1]) | is.na( temp3[,c("clu_new")][i-1]) ) next 
        else if (temp3[,c(paste0("clu",y0))][i] == temp3[,c(paste0("clu",y0))][i-1] 
                 & temp3[,c("clu_new")][i] == temp3[,c("clu_new")][i-1])
          
          temp3$diff[i] <- 1
      }
      
      temp3 <- temp3 %>%
        filter(diff != 1)
      
      temp <- temp3 %>% select(-diff)
      
      
      rm(temp3)
      
    }
    
    if (rep_c == 3){
      break
    }
    
  }
  
  temp <- as.data.table(temp) %>%
    mutate(!!paste0("clu",quo_name(y0)) := as.numeric(as.character(get(paste0("clu",y0)))))
  
  data_mun <- data_mun %>% select(-clu_new) %>% left_join(temp) %>% 
    mutate(!!paste0("clu",quo_name(y0)) := ifelse(!(is.na(clu_new)),clu_new,get(paste0("clu",y0)))) %>% select(-clu_new)
  
  rm(temp,temp2)  
  
  return(data_mun)
}                                    
                                    
# # test
# states <- geobr::read_state()
# a <- dissolve_polygons(states, group_column='code_region')
# plot(a)

